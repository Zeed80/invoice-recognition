# Руководство по использованию системы распознавания счетов

## Содержание
1. [Общее описание](#общее-описание)
2. [Графический интерфейс](#графический-интерфейс)
3. [API интерфейс](#api-интерфейс)
4. [Пакетная обработка](#пакетная-обработка)
5. [Мониторинг и метрики](#мониторинг-и-метрики)
6. [Дообучение модели](#дообучение-модели)
7. [Устранение неполадок](#устранение-неполадок)

## Общее описание

Система распознавания счетов предоставляет три режима работы:
1. GUI-режим для обработки отдельных счетов
2. API-режим для интеграции с внешними системами
3. Batch-режим для обработки пакетов изображений

### Поддерживаемые форматы файлов
- Изображения: JPG, JPEG, PNG
- Документы: PDF
- Максимальный размер файла: 10 МБ

### Распознаваемые области счета
- Номер счета
- Дата
- Общая сумма
- Наименование поставщика
- ИНН
- Таблица товаров
- Адрес
- Платежная информация
- Логотип

## Графический интерфейс

### Запуск GUI
```bash
python src/gui/main.py
```

### Основные функции
1. Загрузка счетов:
   - Перетащите файлы в окно программы
   - Используйте кнопку "Открыть файл"
   - Выберите директорию с файлами

2. Просмотр результатов:
   - Выделенные области подсвечиваются на изображении
   - Распознанный текст отображается в таблице
   - Возможность ручной корректировки результатов

3. Настройки:
   - Выбор темы (светлая/темная)
   - Настройка размера окна
   - Параметры автоматического сохранения

4. Экспорт результатов:
   - JSON формат
   - Excel таблица
   - PDF отчет

### Горячие клавиши
- Ctrl+O: Открыть файл
- Ctrl+S: Сохранить результаты
- Ctrl+Z: Отменить последнее действие
- Ctrl+Y: Повторить отмененное действие
- Ctrl+Q: Выход

## API интерфейс

### Базовый URL
```
http://localhost:8000/api/v1
```

### Основные эндпоинты

1. Проверка здоровья системы:
```bash
GET /health
```

2. Загрузка счета:
```bash
POST /invoices/upload
Content-Type: multipart/form-data
```
Параметры:
- file: файл счета
- priority: приоритет (1-3)

3. Получение статуса обработки:
```bash
GET /invoices/{invoice_id}/status
```

4. Получение результатов:
```bash
GET /invoices/{invoice_id}/results
```

5. Пакетная загрузка:
```bash
POST /invoices/batch
Content-Type: multipart/form-data
```
Параметры:
- files: массив файлов
- priority: приоритет (1-3)

### Примеры использования

1. Загрузка счета:
```bash
curl -X POST http://localhost:8000/api/v1/invoices/upload \
  -F "file=@invoice.jpg" \
  -F "priority=1"
```

2. Получение результатов:
```bash
curl http://localhost:8000/api/v1/invoices/123/results
```

## Пакетная обработка

### Запуск обработчика
```bash
python src/worker/main.py
```

### Настройка очереди
1. Приоритеты:
   - 1: Высокий (обработка в течение 1 минуты)
   - 2: Средний (обработка в течение 5 минут)
   - 3: Низкий (обработка в течение 15 минут)

2. Мониторинг очереди:
   - Веб-интерфейс: http://localhost:15672
   - Логи: logs/worker.log

### Обработка директории
```bash
python src/worker/batch.py --input-dir data/input --output-dir data/output
```

## Мониторинг и метрики

### Метрики качества
- Precision: точность распознавания
- Recall: полнота распознавания
- F1-score: среднее гармоническое

### Мониторинг через Metabase
1. Откройте http://localhost:3000
2. Войдите с учетными данными
3. Выберите дашборд "Invoice Recognition Metrics"

### Логирование
- Основной лог: logs/invoice_processing.log
- Лог ошибок: logs/error.log
- Лог дообучения: logs/training.log

## Дообучение модели

### Сбор данных для дообучения
1. Разметка через Label Studio:
   - Откройте http://localhost:8080
   - Создайте проект "Invoice Recognition"
   - Загрузите изображения для разметки

2. Экспорт размеченных данных:
```bash
python scripts/export_training_data.py --output data/training
```

### Процесс дообучения
1. Подготовка данных:
```bash
python scripts/prepare_training.py --input data/training --output data/training_prepared
```

2. Запуск дообучения:
```bash
python scripts/train_model.py --config config/training.json
```

3. Валидация модели:
```bash
python scripts/validate_model.py --model models/latest.pt
```

## Устранение неполадок

### Проблемы с распознаванием
1. Низкое качество распознавания:
   - Проверьте качество исходного изображения
   - Увеличьте порог уверенности в конфигурации
   - Проверьте наличие всех необходимых моделей

2. Ошибки детекции:
   - Проверьте настройки YOLO модели
   - Убедитесь в достаточном количестве GPU памяти
   - Проверьте версию CUDA

### Проблемы с производительностью
1. Медленная обработка:
   - Увеличьте количество workers
   - Проверьте загрузку GPU
   - Оптимизируйте размер батча

2. Утечки памяти:
   - Проверьте логи на наличие утечек
   - Перезапустите обработчик
   - Очистите временные файлы

### Проблемы с очередью
1. Зависание задач:
   - Проверьте статус RabbitMQ
   - Проверьте логи обработчика
   - Перезапустите очередь

2. Потеря задач:
   - Проверьте настройки персистентности
   - Проверьте логи на наличие ошибок
   - Восстановите задачи из бэкапа 